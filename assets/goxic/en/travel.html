<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
<!-- >>> title >>> -->
Travel
<!-- <<< title <<< -->
	</title>
    <link rel="shortcut icon" type="image/x-icon" href="../../s/img/logo.ico">
    <link rel="stylesheet" type="text/css" href="../../s/css/th-bright.css">
    <link rel="stylesheet" type="text/css" href="../../s/css/bcp.css">
    <script src="../../s/js/vue.js"></script>
	<!-- >>> style >>> -->
	<style>
#jumps {
  float: left;
  width: 20%;
  height: 100vh;
  margin-right: 1em;
  padding: 0 .5em;
  overflow-y: auto;
}
#jumps>div {
  background-color: var(--colBkgDim);
  border-radius: .4em;
	padding: .3em .5em;
	margin-bottom: .5em;
	box-shadow: 0 0 5px var(--colFgr) inset;
}
#jumps>div:hover { color: var(--colFgrAlt); }
#tmap {
	display: block;
	margin: 0 auto;
	border: 2px solid var(--colFgrDim);
	background-image: url("/s/img/mway.jpg");
	background-size: 300px 300px;
	background-repeat: no-repeat;
	background-color: black;
}
#bms h1 {
  font-size: 150%;
  margin: 0;
  margin-top: .3em;
}
	</style>
<!-- <<< style <<< -->
  </head>
  <body>
    <div id="vue-app">
      <header>
		<img id="hdrLgo" src="/s/img/Logo.png" alt="logo">
		<div id="hdrCmd">CMDR {{hdr.Name}}</div>
		<div id="hdrShp">{{hdr.Ship.Name}} [{{hdr.Ship.Ident}}]</div>
		<div id="hdrLoc"><span v-if="hdr.Loc.RefNm">{{hdr.Loc.RefNm}}
		/ </span>{{hdr.Loc.Sys.Name}}</div>
      </header>
      <nav>
	<div id="mbtn">
	  <span v-if="ctrl.showMenu"
		v-on:click="ctrl.showMenu=false">⨯</span>
	  <span v-else v-on:click="ctrl.showMenu=true">☰</span>
	</div>
	<div v-for="tab in tabs" :key="tab.key"
	     v-bind:class="{current: tab.key == activeTab}">
	  <span v-if="tab.key == activeTab">{{tab.title}}</span>
	  <span v-else><a :href="tab.url">{{tab.title}}</a></span>
	</div>
      </nav>
      <transition name="menuhttps://localhost:1337/travel">
	<aside v-show="ctrl.showMenu">
	  <div>Settings…</div>
	  <div><a href="/s/debug/log.html"
			  target="bcplog"
			  v-on:click="ctrl.showMenu=false">Show log…</a></div>
	  <div>Quit</div>
	</aside>
      </transition>
    </div>
	<script>
if (!window["WebSocket"]) {
	console.log("browser does not support web sockets");
}
const locRTyNm = ["?", "Deep Space", "Star", "Belt", "Planet",
				  "Ring", "Station", "Outpost", "Port", "Settlement", "Jump Target"];
const locModeNm = ["?", "Parked", "Travel", "Super Cruise", "FSD Jump"];
const locVhclNm = ["?", "Ship", "SRV", "Fighter", "Crew Member"];
Vue.filter('int', function(x) {
    return x.toLocaleString('`lang\jsStr`',{
      useGrouping: true
    });
});
Vue.filter('f4', function(x) {
    return x.toLocaleString('`lang\jsStr`',{
      useGrouping: true,
      minimumIntegerDigits: 1,
      minimumFractionDigits: 4,
      maximumFractionDigits: 4
    });
});
Vue.filter('f2', function(x) {
    return x.toLocaleString('`lang\jsStr`',{
      useGrouping: true,
      minimumIntegerDigits: 1,
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
});
var scrnApp = new Vue({
  el: '#vue-app',
  data: {
	  ctrl: { showMenu: false },
	  activeTab: 'travel',
	  tabs: {
		"key": "travel",
		"title": "Travel",
		"url": "/travel"
	  },
	  hdr: {
		  Name: "–",
		  Ship: {Name: "–", Ident: "–"},
		  Loc: {}
	  }
	},
	filters: {
	    refTy: function(v) {
			var res = locRTyNm[v];
			return res ? res : "("+v+")";
		},
		modNm: function(v) { return locModeNm[v]; },
		vhcNm: function(v) { return locVhclNm[v]; },
		frac: function(v) {
			return v.toLocaleString('`lang\jsStr`');
		}
	},
	methods: {
		onMsg: function(evt) {
			switch (evt.Cmd) {
			case "upd":
				if (evt.Hdr) {
					this.hdr = evt.Hdr;
				}
				break;
			}
		}
	}
});
	</script>
<!-- >>> main >>> -->
	  <main>
      <div id="jumps" @mouseleave="drawLoc()">
        <div v-for="(jmp, i) in Jumps" :key="i"
             @mouseover="draw(jmp.Coos[0],jmp.Coos[1],jmp.Coos[2])">
          {{jmp.Name}}<br/>
          {{(new Date(jmp.Time)).toLocaleString()}}
        </div>
      </div>
		  <trvlmap ref="tmap" :size="300" :hbar="40"></trvlmap>
      <div id="bms">
        <h1>Bookmarks</h1>
        <table>
          <tr>
            <th>Goal</th>
            <th>Mark</th>
            <th>System</th>
            <th>Distance</th>
            <th>Coos</th>
          </tr>
        </table>
      </div>
	  </main>
	  <script>
function screenZ(ly, sd2) { return sd2-2*sd2*Math.atan(ly/800)/Math.PI; }
Vue.component('trvlmap', {
	props: {
		size: Number,
		hbar: Number
	},
	template: '<canvas id="tmap" :width="(2*size)+hbar" :height="size"></canvas>',
	computed: {
		g2: function() {
			var canvas = this.$el;
			return canvas.getContext("2d");
		}
	},
	methods: {
		draw: function(lx, ly, lz) {
			const sd2 = this.size/2;
			const scale = this.size/94000;
			var sx = sd2+scale*lx;
			var sy = .765*this.size-scale*lz;
      var sz = screenZ(ly, sd2);
			var g2 = this.g2;
			g2.shadowBlur = 0;
      g2.clearRect(0, 0, 2*this.size+this.hbar, this.size);
			g2.font="14px Arial";
			g2.fillStyle="#713200";
			g2.fillRect(this.size, 0, this.hbar, this.size);
      g2.fillStyle="#BE5400";
      g2.fillRect(this.size, sd2, this.hbar, sz-sd2);
      g2.lineWidth = 1;
      g2.strokeStyle = "black";
      for (let y = -4000; y <= 4000; y += 1000) {
        let z = screenZ(y, sd2);
        g2.beginPath();
        g2.moveTo(this.size, z);
        g2.lineTo(this.size + this.hbar, z);
        g2.stroke();
      }
      for (let y = -1500; y <= 1500; y += 1000) {
        let z = screenZ(y, sd2);
        g2.beginPath();
        g2.moveTo(this.size, z);
        g2.lineTo(this.size + .5*this.hbar, z);
        g2.stroke();
      }
			g2.beginPath();
      g2.lineWidth = 1.3;
			g2.strokeStyle = "#00A6EA";
			g2.shadowColor = "black";
			g2.shadowBlur = 8;
			g2.moveTo(sx, sy);
			g2.lineTo(this.size, sz);
			g2.lineTo(this.size+this.hbar, sz);
			g2.moveTo(0, sy);
			g2.lineTo(sx, sy);
			g2.lineTo(sx, this.size);
			g2.stroke();
			g2.beginPath();
      g2.arc(sx, sy, 10, 0, 2*Math.PI);
			g2.stroke();
			g2.fillStyle = "white";
      var lb = Math.round(ly);
      var tw = g2.measureText(lb).width;
      if (sz < sd2) {
        g2.fillText(lb, this.size+this.hbar/2-tw/2, sz+13);        
      } else {
        g2.fillText(lb, this.size+this.hbar/2-tw/2, sz-3);        
      }
			if (sx > sd2) {
        lb = Math.round(lx)
				tw = g2.measureText(lb).width;
				g2.fillText(lb, sx-tw-3, this.size-3);
			} else {
				g2.fillText(Math.round(lx), sx+5, this.size-3);
			}
			if (sy > sd2) {
				g2.fillText(Math.round(lz), 5, sy-4);
			} else {
				g2.fillText(Math.round(lz), 5, sy+15);
			}
		}
	},
});
var trvlApp = new Vue({
	el: "main",
  data: `data`,
  methods: {
    draw: function(x,y,z) { this.$refs.tmap.draw(x,y,z); },
    drawLoc: function() {
      let coo = hdrData.Loc.Sys.Coos;
		  this.$refs.tmap.draw(coo[0], coo[1], coo[2]);      
		  //this.$refs.tmap.draw(0,3000,0);      
    },
    onMsg: function(evt) {
      if (evt.Cmd != "upd") return;
      this.drawLoc(); }
  },
	mounted: function() {
    wspgmsg.push(this.onMsg);
    console.log("added travel callback");
    this.drawLoc();
  }
});
	  </script>
<!-- <<< main <<< -->
  </body>
</html>
